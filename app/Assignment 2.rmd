---
title: "R Notebook"
author: fxy11
date: 10/9/2020
output: html_document
runtime: shiny
---

```{r}
library(shiny)
library(plotly)
library(shinythemes)
library(shiny)
library(shinydashboard)
library(leaflet)
library(shinyWidgets)
library(reshape2)
```

```{r}
ui <- dashboardPage(skin = "red",
                    dashboardHeader(title = "NYC Covid_19"),
                    dashboardSidebar(sidebarMenu(
                        menuItem("Home", tabName = "Home", icon = icon("home")),
                        menuItem("Animation", tabName = "Animation", icon = icon("train")),
                        menuItem("Map", tabName = "Map", icon = icon("map")),
                        menuItem("Report", tabName = "Report", icon = icon("industry"))
                    )),
                    dashboardBody(
                        tabItems(
                            #home
                          tabItem(tabName = "Map",
                                  fluidPage(
                                    leafletOutput("map",width="100%",height=750),
                                                  checkboxGroupInput("Borough", "Choose Borough:",
                                                                     choices = c("Manhattan", "Staten Island",
                                                                                 "Bronx", "Queens",
                                                                                 "Brooklyn"),
                                                                     selected = c("Manhattan", "Staten Island",
                                                                                  "Bronx", "Queens",
                                                                                  "Brooklyn")
                                                  ),

                                                  radioButtons("Category", "Choose category:",
                                                                choices = c("COVID_CASE_COUNT","COVID_DEATH_COUNT", "TOTAL_COVID_TESTS", "PERCENT_POSITIVE"))

                                  )
                          )
                        ))
)
```

```{r}
server <- function(input, output) {

  na_drop <- read.csv("https://raw.githubusercontent.com/nychealth/coronavirus-data/master/data-by-modzcta.csv")
  na_drop <- melt(na_drop, id.vars=1:3, value.name="Count", variable.name="Category")
  zip_code <- read.csv('https://raw.githubusercontent.com/daling11/xxxxxxxx/master/zip_code_database.csv')
  colnames(zip_code)<-c('MODIFIED_ZCTA', 'lat', 'lon')
  na_drop <- merge(na_drop, zip_code, by='MODIFIED_ZCTA')

  shiny_data <- reactive(na_drop[which(na_drop$Category %in% input$Category & na_drop$BOROUGH_GROUP %in% input$Borough),])

  output$map <- renderLeaflet({
     leaflet(options = leafletOptions(minZoom = 8, maxZoom = 18)) %>%
      setView(-73.9252853, 40.7910694, zoom = 10) %>%
      addTiles() %>%
      addMarkers(data = shiny_data()$Count, lng = shiny_data()$lon, lat = shiny_data()$lat,
                 clusterOptions = markerClusterOptions()
      )
  })

  observe({
    df.marker <- shiny_data()
    leafletProxy("mapMarker", data = df.marker) %>%
      clearMarkerClusters()%>%
      clearPopups() %>%
      clearMarkers() %>%
      addMarkers(lng = shiny_data()$lon, lat = shiny_data()$lat,
                 popup = paste("<b>", "Category:", "Count", shiny_data()$Count,
                                       "<br/>", "<b>", "Borough:", shiny_data()$BOROUGH_GROUP))
    clusterOptions <- markerClusterOptions()
  })
}
```

```{r echo = FALSE}
shinyApp(ui, server)
```
